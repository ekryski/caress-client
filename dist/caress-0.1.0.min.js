/*! caress-client - v0.1.0 - 2013-01-17
* https://github.com/ekryski/caress-client
* Copyright (c) 2013 Eric Kryski; Licensed MIT */
(function(e,t){function ft(e){if(e&&e.__wrapped__)return e;if(!(this instanceof ft))return new ft(e);this.__wrapped__=e}function dt(e,t,n){t||(t=0);var r=e.length,i=r-t>=(n||a),s=i?{}:e;if(i){var o=t-1;while(++o<r){var u=e[o]+"";(k.call(s,u)?s[u]:s[u]=[]).push(e[o])}}return function(e){if(i){var n=e+"";return k.call(s,n)&&jt(s[n],e)>-1}return jt(s,e,t)>-1}}function vt(e,n){var r=e.index,i=n.index;e=e.criteria,n=n.criteria;if(e!==n){if(e>n||e===t)return 1;if(e<n||n===t)return-1}return r<i?-1:1}function mt(e,t,n){function o(){var u=arguments,a=i?this:t;r||(e=t[s]),n.length&&(u=u.length?n.concat(O.call(u)):n);if(this instanceof o){Et.prototype=e.prototype,a=new Et;var f=e.apply(a,u);return f&&ut[typeof f]?f:a}return e.apply(a,u)}var r=_t(e),i=!n,s=e;return i&&(n=t),o}function gt(e,n){return e?typeof e!="function"?function(t){return t[e]}:n!==t?function(t,r,i){return e.call(n,t,r,i)}:e:Rt}function yt(){var e={arrayLoop:"",bottom:"",hasDontEnumBug:K,isKeysFast:it,objectLoop:"",noArgsEnum:G,noCharByIndex:et,shadowed:E,top:"",useHas:!0};for(var t,n=0;t=arguments[n];n++)for(var r in t)e[r]=t[r];var i=e.args;e.firstArg=/^[^,]+/.exec(i)[0];var s=Function("createCallback, hasOwnProperty, isArguments, objectTypes, nativeKeys, propertyIsEnumerable, stringClass, toString","return function("+i+") {\n"+lt(e)+"\n}");return s(gt,k,xt,ut,B,A,J,M)}function bt(e){return"\\"+at[e]}function wt(e){return Lt[e]}function Et(){}function St(e){return At[e]}function xt(e){return M.call(e)==q}function Ct(e){var t=!1;if(!e||typeof e!="object"||xt(e))return t;var n=e.constructor;return(!tt||typeof e.toString=="function"||typeof (e+"")!="string")&&(!_t(n)||n instanceof n)?Q?(Tt(e,function(e,n,r){return t=!k.call(r,n),!1}),t===!1):(Tt(e,function(e,n){t=n}),t===!1||k.call(e,t)):t}function kt(e){var t=[];return Nt(e,function(e,n){t.push(n)}),t}function Ot(e){var t=[];return Tt(e,function(e,n){_t(e)&&t.push(n)}),t.sort()}function _t(e){return typeof e=="function"}function Ht(e,t,n){var r=-1,i=e?e.length:0,s=Array(typeof i=="number"?i:0);t=gt(t,n);if(Mt(e))while(++r<i)s[r]=t(e[r],r,e);else Pt(e,function(e,n,i){s[++r]=t(e,n,i)});return s}function Bt(e){var t=-1,n=e?e.length:0,r=T.apply(i,arguments),s=dt(r,n),o=[];while(++t<n){var u=e[t];s(u)||o.push(u)}return o}function jt(e,t,n){var r=-1,i=e?e.length:0;if(typeof n=="number")r=(n<0?j(0,i+n):n||0)-1;else if(n)return r=Ft(e,t),e[r]===t?r:-1;while(++r<i)if(e[r]===t)return r;return-1}function Ft(e,t,n,r){var i=0,s=e?e.length:i;n=n?gt(n,r):Rt,t=n(t);while(i<s){var o=i+s>>>1;n(e[o])<t?i=o+1:s=o}return i}function It(e,t){return rt||_&&arguments.length>2?_.call.apply(_,arguments):mt(e,t,O.call(arguments,2))}function qt(e){var t=arguments,n=t.length>1?0:(t=Ot(e),-1),r=t.length;while(++n<r){var i=t[n];e[i]=It(e[i],e)}return e}function Rt(e){return e}function Ut(){return e._=f,this}function zt(){return this.__chain__=!0,this}function Wt(){return this.__wrapped__}var n=typeof exports=="object"&&exports,r=typeof global=="object"&&global;r.global===r&&(e=r);var i=[],s={},o=0,u={},a=30,f=e._,l=/[-?+=!~*%&^<>|{(\/]|\[\D|\b(?:delete|in|instanceof|new|typeof|void)\b/,c=/&(?:amp|lt|gt|quot|#x27);/g,h=/\b__p \+= '';/g,p=/\b(__p \+=) '' \+/g,d=/(__e\(.*?\)|\b__t\)) \+\n'';/g,v=/\w*$/,m=/(?:__e|__t = )\(\s*(?![\d\s"']|this\.)/g,g=RegExp("^"+(s.valueOf+"").replace(/[.*+?^=!:${}()|[\]\/\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),y=/($^)/,b=/[&<>"']/g,w=/['\n\r\t\u2028\u2029\\]/g,E=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],S=0,x=Math.ceil,T=i.concat,N=Math.floor,C=g.test(C=Object.getPrototypeOf)&&C,k=s.hasOwnProperty,L=i.push,A=s.propertyIsEnumerable,O=i.slice,M=s.toString,_=g.test(_=O.bind)&&_,D=g.test(D=Array.isArray)&&D,P=e.isFinite,H=e.isNaN,B=g.test(B=Object.keys)&&B,j=Math.max,F=Math.min,I=Math.random,q="[object Arguments]",R="[object Array]",U="[object Boolean]",z="[object Date]",W="[object Function]",X="[object Number]",V="[object Object]",$="[object RegExp]",J="[object String]",K,Q,G=!0;(function(){function t(){this.x=1}var e=[];t.prototype={valueOf:1,y:1};for(var n in new t)e.push(n);for(n in arguments)G=!n;K=!/valueOf/.test(e),Q=e[0]!="x"})(1);var Y=!xt(arguments),Z=O.call("x")[0]!="x",et="x"[0]+Object("x")[0]!="xx";try{var tt=({toString:0}+"",M.call(e.document||0)==V)}catch(nt){}var rt=_&&/\n|Opera/.test(_+M.call(e.opera)),it=B&&/^.+$|true/.test(B+!!e.attachEvent);try{var st=(Function("//@")(),!e.attachEvent)}catch(nt){}var ot={};ot[q]=ot[W]=!1,ot[R]=ot[U]=ot[z]=ot[X]=ot[V]=ot[$]=ot[J]=!0;var ut={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,"undefined":!1},at={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"};ft.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,variable:""};var lt=function(e){var t="var index, value, iteratee = "+e.firstArg+", result = "+e.firstArg+";\nif (!"+e.firstArg+") return result;\n"+e.top+";\n";e.arrayLoop?(t+="var length = iteratee.length; index = -1;\nif (typeof length == 'number') {  ",e.noCharByIndex&&(t+="\n  if (toString.call(iteratee) == stringClass) {\n    iteratee = iteratee.split('')\n  }  "),t+="\n  while (++index < length) {\n    value = iteratee[index];\n    "+e.arrayLoop+"\n  }\n}\nelse {  "):e.noArgsEnum&&(t+="\n  var length = iteratee.length; index = -1;\n  if (length && isArguments(iteratee)) {\n    while (++index < length) {\n      value = iteratee[index += ''];\n      "+e.objectLoop+"\n    }\n  } else {  "),e.hasDontEnumBug||(t+="\n  var skipProto = typeof iteratee == 'function' && \n    propertyIsEnumerable.call(iteratee, 'prototype');\n  ");if(e.isKeysFast&&e.useHas)t+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iteratee] ? nativeKeys(iteratee) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",e.hasDontEnumBug||(t+="if (!(skipProto && index == 'prototype')) {\n  "),t+="    value = iteratee[index];\n    "+e.objectLoop+"",e.hasDontEnumBug||(t+="}\n"),t+="  }  ";else{t+="\n  for (index in iteratee) {";if(!e.hasDontEnumBug||e.useHas)t+="\n    if (",e.hasDontEnumBug||(t+="!(skipProto && index == 'prototype')"),!e.hasDontEnumBug&&e.useHas&&(t+=" && "),e.useHas&&(t+="hasOwnProperty.call(iteratee, index)"),t+=") {    ";t+="\n    value = iteratee[index];\n    "+e.objectLoop+";    ";if(!e.hasDontEnumBug||e.useHas)t+="\n    }";t+="\n  }  "}if(e.hasDontEnumBug){t+="\n\n  var ctor = iteratee.constructor;\n    ";for(var n=0;n<7;n++)t+="\n  index = '"+e.shadowed[n]+"';\n  if (",e.shadowed[n]=="constructor"&&(t+="!(ctor && ctor.prototype === iteratee) && "),t+="hasOwnProperty.call(iteratee, index)) {\n    value = iteratee[index];\n    "+e.objectLoop+"\n  }    "}if(e.arrayLoop||e.noArgsEnum)t+="\n}";return t+=e.bottom+";\nreturn result",t},ct={args:"collection, callback, thisArg",top:"callback = createCallback(callback, thisArg)",arrayLoop:"if (callback(value, index, collection) === false) return result",objectLoop:"if (callback(value, index, collection) === false) return result"},ht={useHas:!1,args:"object",top:"for (var argsIndex = 1, argsLength = arguments.length; argsIndex < argsLength; argsIndex++) {\n  if (iteratee = arguments[argsIndex]) {",objectLoop:"result[index] = value",bottom:"  }\n}"},pt={arrayLoop:null};Y&&(xt=function(e){return e?k.call(e,"callee"):!1});var Tt=yt(ct,pt,{useHas:!1}),Nt=yt(ct,pt),Lt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},At={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#x27;":"'"},Mt=D||function(e){return M.call(e)==R};_t(/x/)&&(_t=function(e){return M.call(e)==W});var Dt=B?function(e){var t=typeof e;return t=="function"&&A.call(e,"prototype")?kt(e):e&&ut[t]?B(e):[]}:kt,Pt=yt(ct);ft.VERSION="0.9.1",ft.bind=It,ft.bindAll=qt,ft.difference=Bt,ft.forEach=Pt,ft.forIn=Tt,ft.forOwn=Nt,ft.functions=Ot,ft.identity=Rt,ft.indexOf=jt,ft.isArguments=xt,ft.isArray=Mt,ft.isFunction=_t,ft.keys=Dt,ft.map=Ht,ft.noConflict=Ut,ft.sortedIndex=Ft,ft.collect=Ht,ft.each=Pt,ft.methods=Ot,typeof define=="function"&&typeof define.amd=="object"&&define.amd?(e._=ft,define(function(){return ft})):n?typeof module=="object"&&module&&module.exports==n?(module.exports=ft)._=ft:n._=ft:e._=ft})(this),function(e){typeof define=="undefined"&&(define=function(t){var n=t();typeof exports=="undefined"?window[e]=n:module.exports=n}),define(function(e,t,n){var r=r||window,i=r._.noConflict();!i&&typeof e!="undefined"&&(i=e("underscore"));var s=t||{};s.version="0.1.0",s.protocol="1.1","object"==typeof n&&"function"==typeof e;var o=s.Client=function(t){t=t||{},this.host=t.host||"127.0.0.1",this.port=t.port||5e3,this.connected=!1,this.sessions={},this.cursors={},this.objects={},this.blobs={},this.touches={},this.touchList=document.createTouchList(),i.bindAll(this,"connect","onConnect","onDisconnect","processPacket","processMessage","processCursorSource","processObjectSource","processBlobSource","processCursorAlive","processObjectAlive","processBlobAlive","processCursorSet","processObjectSet","processBlobSet","processFseq")};o.prototype.connect=function(){this.socket=io.connect("http://"+this.host+":"+this.port),this.socket.on("connect",this.onConnect),this.socket.on("disconnect",this.onDisconnect)},o.prototype.onConnect=function(){this.connected=!0,this.socket.on("tuio",this.processPacket),console.log("Connected to Socket.io")},o.prototype.onDisconnect=function(){this.connected=!1;for(var e in this.touches)for(var t in this.touches[e]){var n=this.touches[e][t];delete this.touches[e][t],this.createTouchEvent("touchcancel",n)}this.touches={},this.cursors={},this.objects={},this.blobs={},console.log("Disconnected from Socket.io")},o.prototype.processPacket=function(e){e.bundle&&this.processMessage(e)},o.prototype.processMessage=function(e){var t={source:this.processCursorSource,alive:this.processCursorAlive,set:this.processCursorSet,fseq:this.processFseq},n={source:this.processObjectSource,alive:this.processObjectAlive,set:this.processObjectSet,fseq:this.processFseq},r={source:this.processBlobSource,alive:this.processBlobAlive,set:this.processBlobSet,fseq:this.processFseq};if(!e.duplicate){e.source="localhost";for(var i in e.messages){var s=e.messages[i].type;switch(e.messages[i].profile){case"/tuio/2Dcur":case"/tuio/25Dcur":case"/tuio/3Dcur":t[s](e,e.messages[i]);break;case"/tuio/2Dobj":case"/tuio/25Dobj":case"/tuio/3Dobj":n[s](e,e.messages[i]);break;case"/tuio/2Dblb":case"/tuio/25Dblb":case"/tuio/3Dblb":r[s](e,e.messages[i])}}}},o.prototype.processCursorSource=function(e,t){e.source=t.address,this.cursors[e.source]===undefined&&(this.cursors[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={})},o.prototype.processObjectSource=function(e,t){e.source=t.address,this.objects[e.source]===undefined&&(this.objects[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={})},o.prototype.processBlobSource=function(e,t){e.source=t.address,this.blobs[e.source]===undefined&&(this.blobs[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={})},o.prototype.processCursorAlive=function(e,t){this.cursors[e.source]===undefined&&(this.cursors[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={});var n=i.map(t.sessionIds,function(e){return e.toString()}),r=i.difference(i.keys(this.cursors[e.source]),n);for(var s=0;s<r.length;s++){var o=r[s],u=this.touches[e.source][o];u!==undefined&&(delete this.touches[e.source][o],delete this.cursors[e.source][o],this.createTouchEvent("touchend",u))}},o.prototype.processObjectAlive=function(e,t){this.objects[e.source]===undefined&&(this.objects[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={});var n=i.map(t.sessionIds,function(e){return e.toString()}),r=i.difference(i.keys(this.objects[e.source]),n);for(var s=0;s<r.length;s++){var o=r[s],u=this.touches[e.source][o];u!==undefined&&(delete this.touches[e.source][o],delete this.objects[e.source][o],this.createTouchEvent("touchend",u))}},o.prototype.processBlobAlive=function(e,t){this.blobs[e.source]===undefined&&(this.blobs[e.source]={}),this.touches[e.source]===undefined&&(this.touches[e.source]={});var n=i.map(t.sessionIds,function(e){return e.toString()}),r=i.difference(i.keys(this.blobs[e.source]),n);for(var s=0;s<r.length;s++){var o=r[s],u=this.touches[e.source][o];u!==undefined&&(delete this.touches[e.source][o],delete this.blobs[e.source][o],this.createTouchEvent("touchend",u))}},o.prototype.processCursorSet=function(e,t){var n=new u(t),r=n.coherceToTouch(),i=t.sessionId.toString();if(this.cursors[e.source][i]!==undefined&&this.cursors[e.source][i].sessionId.toString()===i){this.cursors[e.source][i]=n;if(this.touches[e.source][i]!==undefined&&this.touches[e.source][i].identifier.toString()===i){this.touches[e.source][i]=r,this.createTouchEvent("touchmove",r);return}return}this.cursors[e.source][i]=n,this.touches[e.source][i]=r,this.createTouchEvent("touchstart",r)},o.prototype.processObjectSet=function(e,t){var n,r,i=t.sessionId.toString();if(this.objects[e.source][i]!==undefined&&this.objects[e.source][i].sessionId.toString()===i){this.objects[e.source][i]=new a(t);if(this.touches[e.source][i]!==undefined&&this.touches[e.source][i].identifier.toString()===i){r=this.objects[e.source][i].coherceToTouch(),this.touches[e.source][i]=r,this.createTouchEvent("touchmove",r);return}return}n=new a(t),r=n.coherceToTouch(),this.objects[e.source][i]=n,this.touches[e.source][i]=r,this.createTouchEvent("touchstart",r)},o.prototype.processBlobSet=function(e,t){var n,r,i=t.sessionId.toString();if(this.blobs[e.source][i]!==undefined&&this.blobs[e.source][i].sessionId.toString()===i){this.blobs[e.source][i]=new f(t);if(this.touches[e.source][i]!==undefined&&this.touches[e.source][i].identifier.toString()===i){r=this.blobs[e.source][i].coherceToTouch(),this.touches[e.source][i]=r,this.createTouchEvent("touchmove",r);return}return}n=new f(t),r=n.coherceToTouch(),this.blobs[e.source][i]=n,this.touches[e.source][i]=r,this.createTouchEvent("touchstart",r)},o.prototype.processFseq=function(e,t){},o.prototype.getCursor=function(e){return this.cursors[sessionId]},o.prototype.getObject=function(e){return this.objects[e]},o.prototype.getBlob=function(e){return this.blobs[e]},o.prototype.getCursors=function(){return this.cursors},o.prototype.getObjects=function(){return this.objects},o.prototype.getBlobs=function(){return this.blobs},o.prototype.createTouchEvent=function(e,t){var n=[];for(var r in this.touches)for(var i in this.touches[r])n.push(this.touches[r][i]);var s=t.getTargetTouches(),o=document.createTouchList([t]),u=document.createEvent("UIEvent");switch(e){case"touchstart":case"touchend":case"touchmove":u.initUIEvent(e||"",!0,!0,t.view||null,0);break;case"touchcancel":u.initUIEvent(e||"",!0,!1,t.view||null,0);break;case"touchenter":case"touchleave":u.initUIEvent(e||"",!1,!0,t.view||null,0)}u.initTouchEvent(n,s,o,e,window,t.screenX,t.screenY,t.clientX,t.clientY,u.ctrlKey,u.altKey,u.shiftKey,u.metaKey);if(t.target)t.target.dispatchEvent(u);else var a=document.dispatchEvent(u)};var u=s.TuioCursor=function(t){for(var n in t)this[n]=t[n]};u.prototype.coherceToTouch=function(){var e=this.sessionId,t=window.innerWidth*this.xPosition,n=window.innerHeight*this.yPosition,r=document.documentElement.clientWidth*this.xPosition,i=document.documentElement.clientHeight*this.yPosition,s=document.elementFromPoint(r,i),o=screen.width*this.xPosition,u=screen.height*this.yPosition,a=this.radius,f=this.radius,l=this.rotationAngle,c=this.force;return document.createTouch(s,e,t,n,r,i,o,u,a,f,l,c)};var a=s.TuioObject=function(t){for(var n in t)this[n]=t[n]};a.prototype.coherceToTouch=function(){var e=this.sessionId,t=window.innerWidth*this.xPosition,n=window.innerHeight*this.yPosition,r=document.documentElement.clientWidth*this.xPosition,i=document.documentElement.clientHeight*this.yPosition,s=document.elementFromPoint(r,i),o=screen.width*this.xPosition,u=screen.height*this.yPosition,a=this.radius,f=this.radius,l=this.rotationAngle,c=this.force;return document.createTouch(s,e,t,n,r,i,o,u,a,f,l,c)};var f=s.TuioBlob=function(t){for(var n in t)this[n]=t[n]};f.prototype.coherceToTouch=function(){var e=this.sessionId,t=window.innerWidth*this.xPosition,n=window.innerHeight*this.yPosition,r=document.documentElement.clientWidth*this.xPosition,i=document.documentElement.clientHeight*this.yPosition,s=document.elementFromPoint(r,i),o=screen.width*this.xPosition,u=screen.height*this.yPosition,a=this.radius,f=this.radius,l=this.rotationAngle,c=this.force;return document.createTouch(s,e,t,n,r,i,o,u,a,f,l,c)};var l=s.Touch=function(t,n,r,i,s,o,u,a,f,l,c,h){return this.identifier=n,this.target=t,this.screenX=u,this.screenY=a,this.clientX=r,this.clientY=i,this.pageX=s,this.pageY=o,this.radiusX=f,this.radiusY=l,this.rotationAngle=c,this.force=h,this};l.prototype.getTargetTouches=function(){var e=document.createTouchList();for(var t in window.client.touches)for(var n in window.client.touches[t]){var r=window.client.touches[t][n];r.target==this.target&&e.push(r)}return e};var c=s.TouchList=function(){var t=[].slice.call(arguments),n=t.length,r=0;this.length=n;for(;r<n;r++)this[r]=t[r];return this};c.prototype=[],c.prototype.identifiedTouch=function(e){for(var t=0;t<this.length;t++)if(this[t].identifier===e)return this[t];return undefined},c.prototype.item=function(e){return this[e]};var h=s.TouchEvent=function(){this.touches=document.createTouchList(),this.targetTouches=document.createTouchList(),this.changedTouches=document.createTouchList(),this.altKey=!1,this.metaKey=!1,this.ctrlKey=!1,this.shiftKey=!1,this.relatedTarget=null};return h.prototype=UIEvent.prototype,h.prototype.initTouchEvent=function(e,t,n,r,i,s,o,u,a,f,l,c,h){this.touches=e||document.createTouchList(),this.targetTouches=t||document.createTouchList(),this.changedTouches=n||document.createTouchList(),this.screenX=s||null,this.screenY=o||null,this.clientX=u||null,this.clientY=a||null,this.altKey=l||!1,this.metaKey=h||!1,this.ctrlKey=f||!1,this.shiftKey=c||!1,this.relatedTarget=null},h.prototype.isTouchEvent=function(){return!0},document.createTouch=function(e,t,n,r,i,s,o,u,a,f,c){return new l(e,t,n,r,i,s,o,u,a,f,c)},document.createTouchList=function(e){var t=new c;if(i.isArray(e)&&e.length){for(var n=0;n<e.length;n++)t.push(e[n]);return t}return!i.isArray(e)&&e!==undefined?(t.push(e),t):t},window.ontouchstart=document.ontouchstart=null,window.ontouchend=document.ontouchend=null,window.ontouchmove=document.ontouchmove=null,window.ontouchcancel=document.ontouchcancel=null,window.ontouchenter=document.ontouchenter=null,window.ontouchleave=document.ontouchleave=null,s})}("Caress");